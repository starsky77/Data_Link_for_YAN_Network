# YAN网络数据链路层需求分析报告



## 1.概述

### 1.1 项目背景

YAN网络是嵌入式系统提出的网络，主要参考APRS网络。本项目旨在实现一个具有APRS网络基本功能的YAN网络并在其上落实一个具体的应用/



### 1.2 总体目标

本小组负责YAN网络数据链路层的KISS Modem for AFSK，旨在实现一个AFSK的调制解调器，其一段以音频线接对讲机，一端以串口接其他单片机，通过KISS协议和单片机通信。小组所负责的内容在整个YAN网络位于最底层的位置，通过OSI模型来描述即需要实现物理层和数据链路层两部分的功能。

需要实现ax.25协议所实现的部分乃至全部功能（而ax.25协议本身是位于物理层和数据链路层的协议），从而为更为上层的网络层提供服务。



## 2.目标系统功能需求

具体需求主要从两个方面来说明：

其一是物理层，旨在通过一个AFSK的调制解调器将数字信号调制为模拟信号发送，或是接收模拟信号并解调为数字信号，实现基本的数据收发功能。

其二是数据链路层，对于从物理层接收并转交的比特流，将其转化为以帧为单位的平滑，基本无错（经过帧FCS校验）的数据传输给更高层；对于上层发送下来的数据包，进行必要的分段并追加一些头，交由物理层进行传输。
<!-- 与 KISS 模式矛盾？ -->

<!-- host传UI帧，分段和加头也许也不需要做？-->

在具体说明两层的需求之前，需要给出ax.25文档中所阐明的关于ax.25的结构，以便更好理解项目需求；

<img src="./img/1.png" style="zoom:60%;" />

简要说明一下其中各个部分的含义：

**DLSAP（Data-Link Service Access Point )**:数据链路层提供给上层的接口，每个data link中含有一个DLSAP；

**Management Data Link**：管理Data link相关参数的状态机，每个data link中含有一个该状态机；

Data Link : Data link层核心部分，控制大多数关键原语（建立/释放连接，传输数据等）的状态机，每个datalink中含有一个该状态机；

**Segmenter**:对上层传输下来的数据包进行必要的分段，每个datalink中含有一个该状态机；

**Link  Multiplexer:**该状态机决定那个data link当前能够使用信道，从而使得多个data link共享一个物理信道，每个物理信道有一个该状态机；

**Physical**:控制底层硬件的状态机；



ax.25的文档给出了所有内容的具体细节，我们需要结合项目需要，选择其中必须实现(基本需求)以及可以实现（进阶需求）的部分。



### 2.1 物理层需求

物理层之下的介质是无线信号，使用 AFSK1200 (Bell 202) 调制标准。该标准

- uses a 1200 Hz tone for mark and 2200 Hz for space
- data rate 1200 bps
- half-duplex 

#### 2.1.1 基本需求

在物理层，数据传送的需求分解为

- 数据的发送：
  - “根据当前时隙发送的比特，
    - 需要维护发送的时序
  - 向模拟口输出 1200 Hz 或 2200 Hz 的正弦波。”
    - 使用 DAC
    - 需要确定一个合适的采样数，既要波形质量足够，又要节省生成波形所花费的算力
    - 由于两种正弦波的周期并非整数倍，在 0 比特 与 1 比特交替时，需要实现相位衔接的逻辑

- 数据的接收：
  - 对模拟口输入进行采样，得到一系列离散电压序列；
    - 使用 ADC
    - 需要确定一个合适的采样数，既要避免欠采样 (例如 aliasing 等后果)，又要节省解算波形所花费的算力
  - 解算出当前传送的是 1200 Hz 还是 2200 Hz 的正弦波，进而得知是 0 比特 还是 1 比特
    - 通过检测电压序列两次过零的时间间隔，算出当前频率
    - 需要维护比特流

- 收与发的协调：
  - 根据 AX.25 FigC2 的状态机，不时向 Link Multiplexer 提供链路闲忙的指示
  - Link Multiplexer 能够请求抢占信道，并在信道成功抢占后得到确认；LM 也能够释放信道
  - Link Multiplexer 能够请求发送帧；该帧可以有优先级
  - 将接收到的比特流提供给 Link Multiplexer. 目前预估是以缓冲区的形式，也可能考虑 C++ 流的实现

#### 2.1.2 进阶需求

- 数据的接收：采用离散傅里叶变换等信号处理技术，高效可靠地解算当前正弦波频率，对噪声鲁棒

### 2.2 数据链路层需求

#### 2.2.1 基本需求

为了和现有的成熟APRS网络通信，数据链路层需要实现对AX.25协议中的UI帧进行收发的功能。

- 数据的发送：
  - 根据KISS协议通过uart与主机通信，从主机发送的字符流中解析出数据帧，该数据帧即为AX.25协议中的UI帧
  - Link Multiplexer通过和物理层交互，发送UI帧
- 数据的接收：
  - 从物理层提供的比特流中解析出AX.25 UI帧
  - 根据KISS协议，通过uart串口将UI帧发给主机
  - KISS协议仅实现简单的界定数据帧的功能

#### 2.2.2 进阶需求

为了在数据链路层进行透明、稳定、可靠的通信，考虑实现完整的AX.25协议，除了提供面向无连接的服务以外，还将提供以下服务：

- 数据链路层参数的协商；
- 数据链路层的错误汇报；

- 面向连接的服务：连接的建立，释放，以及面向连接的数据传输。

## 3.目标系统接口需求
